<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost Loot - HUD</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="app-container">
        <header class="hud-header">
            <h1>Your Progress</h1>
            <div id="timer-container">
                <span>Time:</span>
                <span id="timer">00:00</span>
            </div>
        </header>

        <main id="hud-screen">
            <div id="location-permission-error" class="hidden">
                <p>This game requires location access to function. Please enable it in your browser settings to continue.</p>
            </div>

            <div id="game-content">
                <section id="proximity-map-container">
                    <h2>Proximity Radar</h2>
                    <div id="proximity-map">
                        <div id="checkpoint-dot" title="Checkpoint Location"></div>
                        <div id="player-dot" title="Your Location"></div>
                    </div>
                    <p id="distance-readout">Acquiring GPS signal...</p>
                </section>

                <section id="clue-board">
                    <h2>Clue Board</h2>
                <ul id="clues-list">
                    <!-- Clues will be populated by JS -->
                </ul>
            </section>

            <section id="inventory">
                <div id="key-inventory">
                    <h2>Golden Keys</h2>
                    <div class="key-slots">
                        <div id="key-slot-1" class="key-slot" data-key-id="1"></div>
                        <div id="key-slot-2" class="key-slot" data-key-id="4"></div>
                        <div id="key-slot-3" class="key-slot" data-key-id="7"></div>
                    </div>
                </div>

                <div id="checkpoint-tracker">
                    <h2>Checkpoints</h2>
                    <div id="checkpoint-grid">
                        <!-- 8 Checkpoint icons will be populated by JS -->
                    </div>
                </div>
            </section>

            <a href="ar.html" id="scan-marker-btn" class="button-primary">Enter AR (Manual)</a>
        </main>
    </div>

    <script type="module">
        import { gameState } from './js/game-state.js';
        import { geolocationService } from './js/geolocation-service.js';
        import { CHECKPOINT_LOCATIONS } from './js/locations.js';

        const timerEl = document.getElementById('timer');
        const cluesListEl = document.getElementById('clues-list');
        const keySlots = document.querySelectorAll('.key-slot');
        const checkpointGridEl = document.getElementById('checkpoint-grid');
        const distanceReadoutEl = document.getElementById('distance-readout');
        const proximityMapEl = document.getElementById('proximity-map');
        const playerDotEl = document.getElementById('player-dot');
        const locationErrorEl = document.getElementById('location-permission-error');
        const gameContentEl = document.getElementById('game-content');

        const PROXIMITY_TRIGGER_METERS = 300;
        let timerInterval;
        let locationWatchId = null;
        let pollingInterval = null;
        const POLLING_RATE_MS = 10000; // Poll every 10 seconds

        // --- Clue Data ---
        const CLUE_DATA = {
            1: "A new journey begins! Use your radar to find the first checkpoint's location.",
            2: "Seek the place where knowledge flows like treasure - the scholar's sanctuary awaits.",
            3: "Where the iron horses sleep, your next challenge lies in wait.",
        };

        function initializeHUD() {
            const state = gameState.get();
            if (!state) {
                window.location.href = 'index.html';
                return;
            }

            updateHUD(state);
            startTimer(state.startTime);
            startLocationTracking(state);

            // Start polling for state changes
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                console.log('Polling for game state updates...');
                try {
                    const latestState = await gameState.sync();
                    if (latestState) {
                        updateHUD(latestState);
                    }
                } catch (error) {
                    console.error('Polling failed:', error);
                }
            }, POLLING_RATE_MS);
        }

        function startLocationTracking(state) {
            const nextCheckpointId = state.unlockedCheckpoints.find(id => !state.completedCheckpoints.includes(id));
            if (!nextCheckpointId) {
                distanceReadoutEl.textContent = "All checkpoints cleared!";
                return;
            }
            const target = CHECKPOINT_LOCATIONS[nextCheckpointId];

            locationWatchId = geolocationService.startTracking(
                (position) => handleLocationUpdate(position, target),
                handleLocationError
            );
        }

        function handleLocationUpdate(position, target, checkpointId) {
            const { latitude, longitude } = position.coords;
            const distance = geolocationService.getDistance(latitude, longitude, target.lat, target.lon);

            distanceReadoutEl.textContent = `Distance: ${Math.round(distance)} meters`;
            updateProximityMap(distance);

            if (distance < PROXIMITY_TRIGGER_METERS) {
                console.log(`Proximity trigger for checkpoint ${checkpointId}! Entering AR...`);
                geolocationService.stopTracking(locationWatchId);
                window.location.href = `ar.html?checkpointId=${checkpointId}`;
            }
        }

        function handleLocationError(error) {
            console.error("Geolocation error:", error.message);
            gameContentEl.classList.add('hidden');
            locationErrorEl.classList.remove('hidden');
            distanceReadoutEl.textContent = "Location access denied.";
        }

        function updateProximityMap(distance) {
            // Clamp the distance for visual representation, e.g., max visible distance is 200m
            const maxDistance = 200;
            const clampedDistance = Math.min(distance, maxDistance);
            // Scale is 0 (far) to 1 (close)
            const scale = 1 - (clampedDistance / maxDistance);

            // Simple visualization: dot moves from edge to center
            const mapSize = proximityMapEl.offsetWidth;
            const position = (mapSize / 2) * (1 - scale);

            playerDotEl.style.top = `${position}px`;
            playerDotEl.style.left = `${position}px`;
            playerDotEl.style.right = `${position}px`;
            playerDotEl.style.bottom = `${position}px`;
        }

        function convertKeysToIds(keysCount) {
            const KEY_CHECKPOINTS = [1, 4, 7];
            return KEY_CHECKPOINTS.slice(0, keysCount);
        }

        function updateHUD(state) {
            // Update Clue Board
            cluesListEl.innerHTML = ''; // Clear existing clues
            state.unlockedCheckpoints.forEach(id => {
                const clueText = CLUE_DATA[id] || `Clue for checkpoint ${id} is a mystery...`;
                const li = document.createElement('li');
                li.textContent = clueText;
                cluesListEl.appendChild(li);
            });

            // Update Key Inventory
            const collectedKeyIds = convertKeysToIds(state.keysCollected);
            keySlots.forEach(slot => {
                const keyId = parseInt(slot.dataset.keyId, 10);
                if (collectedKeyIds.includes(keyId)) {
                    slot.classList.add('collected');
                } else {
                    slot.classList.remove('collected');
                }
            });

            // Update Checkpoint Grid
            checkpointGridEl.innerHTML = ''; // Clear existing grid
            for (let i = 1; i <= 8; i++) {
                const cell = document.createElement('div');
                cell.classList.add('checkpoint-cell');
                cell.textContent = i;
                if (state.completedCheckpoints.includes(i)) {
                    cell.classList.add('completed');
                }
                checkpointGridEl.appendChild(cell);
            }
        }

        function startTimer(startTime) {
            if (timerInterval) clearInterval(timerInterval);

            const startTimestamp = new Date(startTime).getTime();

            timerInterval = setInterval(() => {
                const now = Date.now();
                const elapsed = Math.floor((now - startTimestamp) / 1000);

                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;

                timerEl.textContent =
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        // Initial call to set up the HUD when the page loads
        initializeHUD();
    </script>
</body>
</html>
